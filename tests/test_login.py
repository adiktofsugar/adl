from context import login, account, utils, db
from mock import patch, MagicMock
import unittest
import base64
import os

class TestLogin(unittest.TestCase):
  def test_actinfo_ok(self):
    reply = '<activationServiceInfo xmlns="http://ns.adobe.com/adept"><authURL>http://adeactivate.adobe.com/adept</authURL><userInfoURL>http://adeactivate.adobe.com/adept</userInfoURL><certificate>TOTO</certificate></activationServiceInfo>'
    with patch('requests.get') as mock_request:
      mock_request.return_value.status_code = 200
      mock_request.return_value.text = reply

      auth_url, user_url, certificate = login.activation_init()
      self.assertEqual(auth_url, "http://adeactivate.adobe.com/adept")
      self.assertEqual(user_url, "http://adeactivate.adobe.com/adept")
      self.assertEqual(certificate, "TOTO")

  def test_authinfo_ok(self):
    reply = '<authenticationServiceInfo xmlns="http://ns.adobe.com/adept"><authURL>http://adeactivate.adobe.com/adept</authURL><certificate>TITI</certificate><signInMethods><signInMethod method="AdobeID" type="direct">Adobe ID</signInMethod><signInMethod method="anonymous" type="direct">anonymous</signInMethod></signInMethods></authenticationServiceInfo>'
    with patch('requests.get') as mock_request:
      mock_request.return_value.status_code = 200
      mock_request.return_value.text = reply

      certificate = login.authentication_init()
      self.assertEqual(certificate, "TITI")

#  def test_generate_fingerprint(self):
#    a = login.generate_device_fingerprint()
#    print a

  def test_sign(self):
    a = account.Account()
    c = account.Config()
    c.authentication_certificate = "MIIEYDCCA0igAwIBAgIER2q5eTANBgkqhkiG9w0BAQUFADCBhDELMAkGA1UEBhMCVVMxIzAhBgNVBAoTGkFkb2JlIFN5c3RlbXMgSW5jb3Jwb3JhdGVkMRswGQYDVQQLExJEaWdpdGFsIFB1Ymxpc2hpbmcxMzAxBgNVBAMTKkFkb2JlIENvbnRlbnQgU2VydmVyIENlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0wODAxMDkxODQzNDNaFw0xODAxMzEwODAwMDBaMHwxKzApBgNVBAMTImh0dHA6Ly9hZGVhY3RpdmF0ZS5hZG9iZS5jb20vYWRlcHQxGzAZBgNVBAsTEkRpZ2l0YWwgUHVibGlzaGluZzEjMCEGA1UEChMaQWRvYmUgU3lzdGVtcyBJbmNvcnBvcmF0ZWQxCzAJBgNVBAYTAlVTMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDZAxpzOZ7N38ZGlQjfMY/lfu4Ta4xK3FRm069VwdqGZIwrfTTRxnLE4A9i1X00BnNk/5z7C0pQX435ylIEQPxIFBKTH+ip5rfDNh/Iu6cIlB0N4I/t7Pac8cIDwbc9HxcGTvXg3BFqPjaGVbmVZmoUtSVOsphdA43sZc6j1iFfOQIDAQABo4IBYzCCAV8wEgYDVR0TAQH/BAgwBgEB/wIBATAUBgNVHSUEDTALBgkqhkiG9y8CAQUwgbIGA1UdIASBqjCBpzCBpAYJKoZIhvcvAQIDMIGWMIGTBggrBgEFBQcCAjCBhhqBg1lvdSBhcmUgbm90IHBlcm1pdHRlZCB0byB1c2UgdGhpcyBMaWNlbnNlIENlcnRpZmljYXRlIGV4Y2VwdCBhcyBwZXJtaXR0ZWQgYnkgdGhlIGxpY2Vuc2UgYWdyZWVtZW50IGFjY29tcGFueWluZyB0aGUgQWRvYmUgc29mdHdhcmUuMDEGA1UdHwQqMCgwJqAkoCKGIGh0dHA6Ly9jcmwuYWRvYmUuY29tL2Fkb2JlQ1MuY3JsMAsGA1UdDwQEAwIBBjAfBgNVHSMEGDAWgBSL7vCBYMmi2h4OUsFYDASwQ/eP6DAdBgNVHQ4EFgQU9RP19K+lzF03he+0T47hCVkPhdAwDQYJKoZIhvcNAQEFBQADggEBAJoqOj+bUa+bDYyOSljs6SVzWH2BN2ylIeZKpTQYEo7jA62tRqW/rBZcNIgCudFvEYa7vH8lHhvQak1s95g+NaNidb5tpgbS8Q7/XTyEGS/4Q2HYWHD/8ydKFROGbMhfxpdJgkgn21mb7dbsfq5AZVGS3M4PP1xrMDYm50+Sip9QIm1RJuSaKivDa/piA5p8/cv6w44YBefLzGUN674Y7WS5u656MjdyJsN/7Oup+12fHGiye5QS5mToujGd6LpU80gfhNxhrphASiEBYQ/BUhWjHkSi0j4WOiGvGpT1Xvntcj0rf6XV6lNrOddOYUL+KdC1uDIe8PUI+naKI+nWgrs="
    reply = '<credentials xmlns="http://ns.adobe.com/adept"><user>urn:uuid:563084fa-6c5c-4489-b8a6-b9e053dcbb7c</user><username method="anonymous"></username><pkcs12>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</pkcs12><encryptedPrivateLicenseKey>RY/f/x2CedmmsrbNgfUopDRJhS5lRgFe4+/wvqvFdSBckoGwo+Q9THFOPIt0d7gyp9XoP/gi6Ysf6k/SdSfHtneaTB/hCXgLPULHg2niZrZcL/vvlAOQuNgV9s+zJF68QIZB6vKPHkveR1WLfLzCWq1A1SvtCzB1xULh7QW2KtCeta4MIv/YUq2kwvU/FPC9tcfbkbr6jb/i9nMl76Y0vKmELXDMQGmIpJLdAZw5efB7ay3DRdcXvs3qDdEB8ucG35PqLsn7/llW6Kwo6C/XNE0E0mGFmDezhYBSkbedeHBpBn92tRlLhrTOzsRAH+NAK8ZMDw3VAmdI2pYIQuq1rxxxmSv/288hfVyc8B90MyTUgjEQUE+D0fcrIreabO+0nx9qANEw3Zm7nCg6/TxqzVOY8EjUXJ+FF+aunKI/VlwS28+/8loFLHXGuHIyfKSN3aaXYyu0FIW5whMwIQ1/R0Pl+xdG3vuRbcIi+a43UmfOM/t7ysYCxjZ0YEeGDPegogrxxk4+I+klWeQg+bbfZ7BDH1KsEe0yDrrw+XL1EzQVNeNdRoYcSYjGzgxxaKpAE1HJDaMmQdrt0jiy0/qwRA9UyXuVLwDY/msRZHJcGPa3u4oBfjKUjvpK7m0wtgeTJCSzN5h5bTH+KJZW37HiAwUVCP1K7o3KcROlsDHn5Ah2BvyRvP/zDA4x/i2gzAixwpwXxzwdyeR5CQV72+B3BFxeYUhM1QVHF/5yB/COtzlamX0C1vC9mBVaoIZvAMwa/LQMET2tt+XYUi8mPzWINOOJi7lQk4KBRIopc3R3zYMV8QLwutt3LNV0t9oloDB8a9mc2ostQjrZsfITtx0pV7TilDjZsr5hMHq7LNJ2dq4=</encryptedPrivateLicenseKey><licenseCertificate>MIIDGDCCAoGgAwIBAgIGAXWLAV5nMA0GCSqGSIb3DQEBBQUAMHwxKzApBgNVBAMTImh0dHA6Ly9hZGVhY3RpdmF0ZS5hZG9iZS5jb20vYWRlcHQxGzAZBgNVBAsTEkRpZ2l0YWwgUHVibGlzaGluZzEjMCEGA1UEChMaQWRvYmUgU3lzdGVtcyBJbmNvcnBvcmF0ZWQxCzAJBgNVBAYTAlVTMB4XDTIwMTEwMjIyMDg0NFoXDTMwMTEwMjIyMDg0NFowODE2MDQGA1UEAxMtdXJuOnV1aWQ6NTYzMDg0ZmEtNmM1Yy00NDg5LWI4YTYtYjllMDUzZGNiYjdjMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDJmedSj+sKaaq7U/Zr1aSR5vAvRXb+8q0xg4Z9cyQDztNe+o2Fz2KxHSyqxjfSZM3dSR859e3iyqcwDYAjLs7ZhLwZCy1zeEGIKyrx2p7oS/RHWYKgEUUdRig6Xrd6/yQzxBzEXDwcMQnQwND9CvRZqDhxYlUKOeZK2fHOOVeQOQIDAQABo4HoMIHlMIG0BgNVHSMEgawwgamAFPUT9fSvpcxdN4XvtE+O4QlZD4XQoYGKpIGHMIGEMQswCQYDVQQGEwJVUzEjMCEGA1UEChMaQWRvYmUgU3lzdGVtcyBJbmNvcnBvcmF0ZWQxGzAZBgNVBAsTEkRpZ2l0YWwgUHVibGlzaGluZzEzMDEGA1UEAxMqQWRvYmUgQ29udGVudCBTZXJ2ZXIgQ2VydGlmaWNhdGUgQXV0aG9yaXR5ggRHarl5MAkGA1UdEwQCMAAwFAYDVR0lBA0wCwYJKoZIhvcvAgEHMAsGA1UdDwQEAwIFIDANBgkqhkiG9w0BAQUFAAOBgQA4RODpTPoBY+YhrLJ06zqjT1iua8VD4UHP5F9pxkbgGyhSHZpkODN82msrcE4Gw7C4s8Y+ZPJW84nwQoeEFDcu8OfuCqrmbARYPfiZW8/bT0ncQHKS7+LGqFHf7ECQC+tdh+tp2GIPW0F3JId6dPO1h96SKI4VcdW33pfLoxoHSA==</licenseCertificate></credentials>'
  
    data = db.DBData()
    data.config = c
    data.accounts = [a]

    with patch('requests.post') as mock_request:
      mock_request.return_value.status_code = 200
      mock_request.return_value.text = reply

      login.sign_in(data, a, None, None)
      self.assertEqual(a.urn, "urn:uuid:563084fa-6c5c-4489-b8a6-b9e053dcbb7c")

if __name__ == '__main__':
  unittest.main()
